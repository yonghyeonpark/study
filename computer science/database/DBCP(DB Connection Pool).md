# DBCP(DB Connection Pool)

백엔드 서버와 DB 서버는 `TCP 기반`으로 통신합니다. TCP는 높은 신뢰성을 제공하지만, `3-way`, `4-way` 핸드셰이크로 인해 커넥션을 여닫을 때마다 `시간적 비용`이 발생합니다. 이러한 문제를 해결하기 위해 `DBCP`를 사용합니다.

- `DBCP`는 미리 커넥션을 생성하여 풀에 보관합니다.
- 요청이 들어오면 풀에서 커넥션을 가져와 사용합니다.
- `스프링 부트`는 기본적으로 `HikariCP`를 사용합니다.

## DB 설정 주요 파라미터 (MySQL 기준)

- **max_connections**
    - 클라이언트와 맺을 수 있는 최대 커넥션 수입니다.
- **wait_timeout**
  - 커넥션이 유휴 (`idle`) 상태로 얼마나 유지될지 결정하는 시간입니다.
  - 다음과 같은 비정상적인 상황에서 커넥션을 정리하는 데 사용됩니다.<br>(DB 서버 입장에서는 이 상황을 인지할 수 없으므로 해당 설정이 필요)
    - 비정상적인 커넥션 종료
    - 커넥션 사용 후 미반환
    - 네트워크 단절

## DBCP 설정 주요 파라미터 (HikariCP 기준)

- **minimumIdle**
    - 풀에서 유지하는 최소한의 유휴(`idle`) 커넥션 수입니다.
    - 기본 값은 `maximumPoolSize`와 동일하며, 이 설정을 권장합니다.
    - `maximumPoolSize`와 다른 값으로 설정하면 커넥션의 생성과 제거가 빈번해질 수 있습니다.
- **maximumPoolSize**
    - 풀이 가질 수 있는 최대 커넥션 수입니다.
    - 유휴(`idle`)와 활성(`active`) 커넥션을 합한 전체 수입니다.
- **maxLifetime**
    - 풀에서 커넥션의 최대 수명을 설정합니다.
    - 쿼리 실행 중에 DB 서버가 커넥션을 종료할 수 있기 때문에, DB의 Connection Time Limit(예: `MySQL`의 `wait_timeout`)보다 짧게 설정하는 것이 좋습니다.
      1. DB 서버의 `wait_timeout` 도달
      2. DB 서버에서 커넥션 종료 
      3. 백엔드 서버는 아직 이 사실을 모름
      4. 해당 커넥션으로 쿼리 실행 시도
      5. 에러 발생
    - 수명이 다한 커넥션은 유휴 상태면 즉시 제거하지만, 활성 상태면 풀로 반환된 후에 제거합니다.
- **connectionTimeout**
    - 풀에서 커넥션을 받기 위한 대기 시간입니다.
    - 사용자의 일반적인 대기 시간을 고려하여 적절히 설정해야 합니다.

## 참고

- [쉬운코드 - DBCP](https://www.youtube.com/watch?v=zowzVqx3MQ4&pp=ygUR7Ims7Jq07L2U65OcIGRiY3A%3D)