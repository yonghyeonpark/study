# 동기화

- 여러 스레드를 동시에 실행하더라도 공유 자원에 대한 일관성을 유지하는 것을 의미합니다.
- 상호배제와 스레드의 간의 실행 순서를 제어하는 것을 포함합니다.

## 경쟁 조건(Race Condition)

- 여러 스레드가 동시에 같은 데이터를 조작할 때, 실행 타이밍이나 접근 순서에 따라 결과가 달라질 수 있는 상황을 의미합니다.

## 임계 영역(Critical Section)

- 공유 데이터의 일관성을 보장하기 위해 하나의 스레드만 진입하여 실행할 수 있는 영역을 의미합니다.

## 상호 배제(Mutual Exclusion)를 위한 동기화 방법

### 스핀락(Spin Lock)

- 락을 획득할 수 있을 때까지 반복해서 시도하는 방식을 의미합니다. (Busy Waiting)
- 원자적 연산을 활용하여 간섭받거나 중단 없이 동작하므로 동일한 메모리 영역에 대해 여러 스레드가 동시에 실행되지 않지만, 기다리는 동안 CPU를 낭비한다는 단점이 있습니다.

### 뮤텍스(Mutex)

- value(0 또는 1)를 사용하여 락의 소유 여부를 확인합니다.
- 한 개의 스레드만 뮤텍스를 소유할 수 있습니다.
- 뮤텍스도 내부적으로 원자적 연산을 사용하여 락을 관리하지만, 락을 획득하지 못한 스레드는 대기 상태로 전환되어 CPU 낭비를 줄입니다. (대기 큐 활용)

### 스핀락 vs 뮤텍스

- 멀티코어 환경에서 임계 영역에서의 작업 시간이 컨텍스트 스위칭보다 짧다면, 스핀락이 뮤텍스보다 성능이 좋을 수 있습니다.
- 하지만 싱글코어 환경에서는 컨텍스트 스위칭 필연적으로 발생하기 때문에 스핀락의 이점이 없습니다.

### 세마포어(Semaphore)

- 여러 스레드가 임계 영역에 접근할 수 있도록 조절하는 동기화 기법입니다.
- 세마포어 변수의 값을 통해 임계 영역에 진입할 수 있는 스레드의 개수를 조절합니다.

#### 세마포어의 종류

- 이진 세마포어 (Binary Semaphore)
  - 세마포어 변숫값이 0 또는 1인 경우
  - 최대 1개의 스레드가 접근 가능
- 계수 세마포어 (Counting Semaphore)
  - 세마포어 변숫값이 1보다 큰 경우
  - 여러 개의 스레드가 동시에 접근 가능

#### 세마포어의 동작

- **wait()**
  - 사용할 수 있는 자원이 없으면 해당 스레드를 대기 상태로 변경합니다.
  - 세마포어 변숫값을 감소시킵니다.
- **signal()**
  - 임계 영역에서의 작업이 끝나면 `signal()`을 호출하여 대기 중인 스레드를 준비상태로 변경합니다.
  - 세마포어 변숫값을 증가시킵니다.
- `wait()`과 `signal()` 연산은 원자적으로 실행되며, 이를 통해 동기화를 보장합니다.
- `wait()`과 `signal()`은 반드시 같은 스레드에서 실행될 필요가 없습니다. 즉, 한 스레드가 `wait()`을 호출하고, 다른 스레드가 `signal()`을 호출할 수 있습니다.

### 뮤텍스 vs 이진 세마포어

- 뮤텍스는 락을 소유한 스레드만 해제할 수 있지만, 세마포어는 wait()과 signal()을 서로 다른 스레드가 호출할 수 있습니다.
- 뮤텍스는 우선순위 상속(Priority Inheritance) 속성을 가지지만, 세마포어는 획득한 주체를 추적하지 않으므로 해당 속성을 지원하지 않습니다.
- 상호 배제만 필요하다면 뮤텍스를, 작업 간 실행 순서 동기화가 필요하다면 세마포어를 사용하는 것이 적절합니다.

### 모니터

- 뮤텍스와 조건 변수(Condition Variable)로 구성됩니다.
- 조건 변수를 통해 특정 조건이 충족될 때까지 스레드가 대기할 수 있습니다.

#### 모니터의 동작 방식

- 조건 변수는 대기 큐를 가집니다.
- **wait()**
  - 스레드가 자기 자신을 대기 큐에 넣고 대기 상태로 전환합니다. (뮤텍스 해제)
- **signal()**
  - 대기 큐에서 스레드 하나를 깨워 실행 가능 상태로 변경합니다.
- **broadcast()**
  - 대기 큐에 있는 모든 스레드를 깨웁니다.
- 이러한 연산들은 모두 원자적으로 실행되어 스레드 간의 동기화가 올바르게 유지됩니다.

#### 모니터의 큐

- 진입 큐(Entry Queue)
  - 임계 영역 진입을 위해 스레드가 대기하는 큐입니다.
- 조건 대기 큐(Condition Queue)
  - 모니터 내부에서 조건 변수의 `wait()` 호출로 인해 특정 조건을 만족할 때까지 스레드들이 대기하는 큐입니다.
  - 각 조건 변수마다 개별적인 대기 큐를 가집니다.