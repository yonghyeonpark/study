# OSIV(Open Session In View)

- OSIV는 영속성 컨텍스트를 `Presentation` 계층까지 열어두는 패턴입니다.
- 영속성 컨텍스트가 활성화되어 있으면 엔티티가 영속 상태로 유지되므로 `Presentation` 계층에서도 지연로딩을 사용할 수 있습니다.

## 과거 OSIV (요청 당 트랜잭션)

- 요청이 들어오면 서블릿 필터나 스프링 인터셉터에서 트랜잭션을 시작하고, 요청이 종료될 때 트랜잭션을 종료하는 방식입니다.
- 영속성 컨텍스트가 처음부터 끝까지 유지되므로 `Presentation` 계층에서도 지연로딩이 가능하여 엔티티를 미리 초기화할 필요가 없다는 장점이 있습니다.
- 하지만 `Presentation` 계층에서도 엔티티를 수정할 수 있어 의도치 않게 데이터베이스에 변경 사항이 반영될 수 있다는 문제가 있습니다.
- 엔티티 래핑을 통한 읽기 메서드 제공, DTO 반환 등으로 이 문제를 해결할 수는 있지만, 이러한 방식은 코드를 복잡하게 만들고 OSIV의 장점을 상쇄시킵니다.

## 스프링 OSIV (비즈니스 계층 트랜잭션)

- 앞서 설명한 OSIV의 문제점으로 인해 현재는 거의 사용되지 않으며, 대신 스프링 프레임워크가 제공하는 OSIV를 사용합니다.
- 스프링 OSIV는 `Service` 계층에서만 트랜잭션을 사용하는 방식입니다.
- 트랜잭션이 시작되면 영속성 컨텍스트를 생성하고, 트랜잭션이 종료될 때 트랜잭션을 커밋하고 영속성 컨텍스트를 플러시합니다. 이때 영속성 컨텍스트는 종료하지 않습니다.
- 엔티티의 변경은 반드시 트랜잭션 내에서만 이루어져야 하므로 `Presentation` 계층에서는 엔티티를 수정할 수 없지만, 영속성 컨텍스트가 유지되므로 조회는 가능합니다.
- 이를 `트랜잭션 없이 읽기`라고 하며, 프록시 객체를 초기화하는 지연로딩도 조회 기능이므로 `트랜잭션 없이 읽기`가 가능합니다.
- 요청이 종료되면 `em.close()`를 통해 영속성 컨텍스트만 종료됩니다. 만약 `em.flush()`를 호출하여 강제로 플러시하려고 하면 `TransactionRequiredException`이 발생하게 됩니다.

### 주의 사항

- 앞서 설명드린 것처럼 트랜잭션이 종료되고 `Service` 계층을 벗어나면, 엔티티를 수정해도 데이터베이스에 반영되지 않습니다.
- 다만 한가지 예외가 있습니다. `Presentation` 계층에서 엔티티를 수정한 후, 곧바로 `View`를 호출하는 것이 아니라 트랜잭션이 있는 비즈니스 로직을 호출하면 변경 감지가 동작하게 됩니다.
- 따라서 안전한 구현을 위해서는 모든 비즈니스 로직의 호출이 완료된 후에 엔티티를 변경하는 것이 바람직합니다.

### OSIV ON

```yaml
spring:
  jpa:
    open-in-view: true # 기본값
```

<img src="https://github.com/user-attachments/assets/7d07743d-d35b-438a-9b57-5b7368c2d031"><br>

#### 장점

- 최초 데이터베이스 커넥션 시작 시점부터 API 응답이 끝날 때까지 영속성 컨텍스트와 데이터베이스 커넥션을 유지하여 **Controller**와 **View**에서도 지연로딩을 할 수 있습니다.

#### 단점

- 너무 오랜 시간 동안 데이터베이스 커넥션 리소스를 사용하기 때문에, 실시간 트래픽이 중요한 애플리케이션에서는 커넥션이 모자랄 수 있고, 이것이 결국 에러로 이어질 수 있습니다.

### OSIV OFF

```yaml
spring:
  jpa:
    open-in-view: false
```

<img src="https://github.com/user-attachments/assets/29106bf8-fec2-4fe9-aeee-6e790cec89a2"><br>

#### 장점

- 트랜잭션을 종료할 때 영속성 컨텍스트를 닫고, 데이터베이스 커넥션도 반환해서 커넥션 리소스를 낭비하지 않습니다.

#### 단점

- 트랜잭션이 종료되는 순간 영속성 컨텍스트를 닫기 때문에, **Controller**와 **View**까지 영속성 컨텍스트가 유지되지 않습니다.
- 프록시 초기화가 불가능해집니다.

## 참고

- [자바 ORM 표준 JPA 프로그래밍](https://www.yes24.com/product/goods/19040233)
- [인프런 영한님 강의](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94)