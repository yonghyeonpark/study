# 영속성 컨텍스트와 엔터티 매니저

## 영속성 컨텍스트

- 영속성 컨텍스트는 `엔터티`를 영구적으로 저장하고 관리하는 환경입니다.<br>
  (실제로 눈에 보이는 것이 아닌 `추상적인` 개념입니다.)
- 영속성 컨텍스트는 엔터티를 구분할 때, 엔터티 클래스 정보와 식별자 값(`@Id`)을 사용합니다.
- **엔터티의 상태**
    - **비영속(new)** : 아직 영속성 컨텍스트에 저장되지 않은 상태
    - **영속(managed)** : 영속성 컨텍스트에 저장되어 관리되는 상태
    - **준영속(detached)** : 영속성 컨텍스트에 저장되었다가 분리된 상태
    - **삭제(removed)** : 삭제된 상태
- **장점**
  - **1차 캐시와 동일성 보장**
    - 조회 시, `1차 캐시`를 먼저 확인하고, 없으면 데이터베이스를 조회합니다.
    - 데이터베이스에서 조회한 엔터티는 `1차 캐시`에 저장됩니다. (`영속화`)
    - 같은 식별자로 여러 번 조회해도 `1차 캐시`에 있는 `동일한` 인스턴스가 반환됩니다.
  - **쓰기 지연**
    - 쿼리를 `쓰기 지연 SQL 저장소`에 모아두었다가 `플러시`가 발생하면 데이터베이스에 한 번에 반영합니다.<br>(`커넥션 시간`을 최소화합니다.)

## 엔터티 매니저 팩토리(EntityManagerFactory)

- `JPA` 구성 정보를 바탕으로 `엔터티 매니저`를 생성하는 역할을 합니다.
- 데이터베이스를 하나만 사용하는 애플리케이션은 보통 하나만 생성합니다.
- 여러 스레드가 동시에 접근해도 안전합니다.

## 엔터티 매니저(EntityManager)

- `영속성 컨텍스트`를 통해 `엔터티`를 관리하는 클래스입니다.
- 엔터티 저장, 수정, 삭제, 조회와 같은 모든 엔터티 관련 작업을 처리합니다.
- 여러 스레드가 동시에 접근하면 동시성 문제가 발생할 수 있어, 스레드 간에는 절대 공유하면 안 됩니다.
  각 스레드는 자신만의 `EntityManager`를 가지며, 요청이 끝나면 `EntityManager`는 닫힙니다.
- 데이터베이스 연결이 필요한 시점(주로 `트랜잭션` 시작 시)에 `커넥션`을 획득합니다.